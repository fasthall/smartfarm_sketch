#!/bin/sh

mkdir /smartfarm_sketch/tmp
mkdir /smartfarm_sketch/tmp/core
mkdir /smartfarm_sketch/tmp/preproc

echo "Detecting libraries used..."
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics  -flto -w -x c++ -E -CC -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "$1" -o "nul"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics  -flto -w -x c++ -E -CC -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "$1" -o "nul"
echo "Generating function prototypes..."
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics  -flto -w -x c++ -E -CC -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "$1" -o "/smartfarm_sketch/tmp/preproc/ctags_target_for_gcc_minus_e.cpp"
echo "Compiling sketch..."
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "$1" -o "$1.o"
echo "Compiling libraries..."
echo "Compiling core..."
avr-gcc -c -g -x assembler-with-cpp -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/wiring_pulse.S" -o "/smartfarm_sketch/tmp/core/wiring_pulse.S.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/WInterrupts.c" -o "/smartfarm_sketch/tmp/core/WInterrupts.c.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/hooks.c" -o "/smartfarm_sketch/tmp/core/hooks.c.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/wiring.c" -o "/smartfarm_sketch/tmp/core/wiring.c.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/wiring_analog.c" -o "/smartfarm_sketch/tmp/core/wiring_analog.c.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/wiring_digital.c" -o "/smartfarm_sketch/tmp/core/wiring_digital.c.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/wiring_pulse.c" -o "/smartfarm_sketch/tmp/core/wiring_pulse.c.o"
avr-gcc -c -g -Os -w -std=gnu11 -ffunction-sections -fdata-sections -MMD -flto -fno-fat-lto-objects -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/wiring_shift.c" -o "/smartfarm_sketch/tmp/core/wiring_shift.c.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/CDC.cpp" -o "/smartfarm_sketch/tmp/core/CDC.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/HardwareSerial.cpp" -o "/smartfarm_sketch/tmp/core/HardwareSerial.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/HardwareSerial0.cpp" -o "/smartfarm_sketch/tmp/core/HardwareSerial0.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/HardwareSerial1.cpp" -o "/smartfarm_sketch/tmp/core/HardwareSerial1.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/HardwareSerial2.cpp" -o "/smartfarm_sketch/tmp/core/HardwareSerial2.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/HardwareSerial3.cpp" -o "/smartfarm_sketch/tmp/core/HardwareSerial3.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/IPAddress.cpp" -o "/smartfarm_sketch/tmp/core/IPAddress.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/PluggableUSB.cpp" -o "/smartfarm_sketch/tmp/core/PluggableUSB.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/Print.cpp" -o "/smartfarm_sketch/tmp/core/Print.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/Stream.cpp" -o "/smartfarm_sketch/tmp/core/Stream.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/Tone.cpp" -o "/smartfarm_sketch/tmp/core/Tone.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/USBCore.cpp" -o "/smartfarm_sketch/tmp/core/USBCore.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/WMath.cpp" -o "/smartfarm_sketch/tmp/core/WMath.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/WString.cpp" -o "/smartfarm_sketch/tmp/core/WString.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/abi.cpp" -o "/smartfarm_sketch/tmp/core/abi.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/main.cpp" -o "/smartfarm_sketch/tmp/core/main.cpp.o"
avr-g++ -c -g -Os -w -std=gnu++11 -fpermissive -fno-exceptions -ffunction-sections -fdata-sections -fno-threadsafe-statics -MMD -flto -mmcu=atmega328p -DF_CPU=8000000L -DARDUINO=10611 -DARDUINO_AVR_SMART_FARM -DARDUINO_ARCH_AVR   "-I/smartfarm_sketch/include/cores/smartfarm" "-I/smartfarm_sketch/include/variants/smartfarm" "/smartfarm_sketch/include/cores/smartfarm/new.cpp" -o "/smartfarm_sketch/tmp/core/new.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/wiring_pulse.S.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/WInterrupts.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/hooks.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/wiring.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/wiring_analog.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/wiring_digital.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/wiring_pulse.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/wiring_shift.c.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/CDC.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/HardwareSerial.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/HardwareSerial0.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/HardwareSerial1.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/HardwareSerial2.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/HardwareSerial3.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/IPAddress.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/PluggableUSB.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/Print.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/Stream.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/Tone.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/USBCore.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/WMath.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/WString.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/abi.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/main.cpp.o"
avr-gcc-ar rcs  "/smartfarm_sketch/tmp/core/core.a" "/smartfarm_sketch/tmp/core/new.cpp.o"
echo "Linking everything together..."
avr-gcc -w -Os -flto -fuse-linker-plugin -Wl,--gc-sections -mmcu=atmega328p  -o "sketch/upload.ino.elf" "$1.o" "/smartfarm_sketch/tmp/core/core.a" "-L/smartfarm_sketch" -lm
avr-objcopy -O ihex -j .eeprom --set-section-flags=.eeprom=alloc,load --no-change-warnings --change-section-lma .eeprom=0  "sketch/upload.ino.elf" "sketch/upload.ino.eep"
avr-objcopy -O ihex -R .eeprom  "sketch/upload.ino.elf" "sketch/upload.ino.hex"
echo "Cleaning unnecessary files..."
rm sketch/main.cpp.d sketch/main.cpp.o sketch/upload.ino.eep sketch/upload.ino.elf
